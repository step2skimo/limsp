<!-- templates/lims/reagents/request_reagent.html -->
{% load static %}
<!DOCTYPE html>
<html>
<head>
  <title>Request Reagents</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-light">
<div class="container py-5">
  <h3 class="mb-4"><i class="bi bi-cart-plus me-1"></i> Request New Reagents</h3>

  <!-- ðŸ”™ Link to Inventory Dashboard -->
  <div class="mb-3">
    <a href="{% url 'inventory_dashboard' %}" class="btn btn-outline-secondary btn-sm">
      <i class="bi bi-arrow-left"></i> Back to Inventory Dashboard
    </a>
  </div>

  <form method="post">
    {% csrf_token %}

    <div class="mb-3">
      <label for="id_email" class="form-label">Recipient Email</label>
      <input type="email" name="email" id="id_email" class="form-control" value="{{ form.email.value|default_if_none:'' }}">
    </div>

    <h5 class="mt-4 mb-3">Reagents</h5>
    <table class="table table-bordered" id="reagent-table">
      <thead class="table-dark">
        <tr>
          <th>Reagent Name</th>
          <th>Quantity</th>
          <th>Unit</th>
          <th>Amount (â‚¦)</th>
          <th>Remove</th>
        </tr>
      </thead>
      <tbody id="formset-body">
        {{ formset.management_form }}
        {% for form in formset %}
          <tr class="reagent-form">
            <td>{{ form.reagent_name }}</td>
            <td>{{ form.quantity }}</td>
            <td>{{ form.unit }}</td>
            <td>{{ form.amount }}</td>
            <td><button type="button" class="btn btn-sm btn-danger remove-form">âœ–</button></td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="d-flex justify-content-between">
      <button type="button" class="btn btn-outline-primary btn-sm" id="add-form">âž• Add Reagent</button>
      <h5>Total Amount: â‚¦<span id="total-amount">0.00</span></h5>
    </div>

    <div class="text-end mt-4">
      <button type="submit" class="btn btn-primary"><i class="bi bi-eye"></i> Preview Request</button>
    </div>
  </form>
</div>

<script>
  function updateTotal() {
    let total = 0;
    $('input[name$="amount"]').each(function () {
      total += parseFloat($(this).val()) || 0;
    });
    $('#total-amount').text(total.toFixed(2));
  }

  $(document).ready(function () {
    updateTotal();

    $('#formset-body').on('input', 'input[name$="amount"]', updateTotal);

    $('#formset-body').on('click', '.remove-form', function () {
      $(this).closest('tr').remove();
      updateTotal();
    });

    let formIdx = {{ formset.total_form_count }};
    $('#add-form').click(function () {
      const newRow = `
        <tr class="reagent-form">
          <td><input type="text" name="form-${formIdx}-reagent_name" class="form-control" required></td>
          <td><input type="number" name="form-${formIdx}-quantity" step="0.01" class="form-control" required></td>
          <td><input type="text" name="form-${formIdx}-unit" class="form-control" required></td>
          <td><input type="number" name="form-${formIdx}-amount" step="0.01" class="form-control" required></td>
          <td><button type="button" class="btn btn-sm btn-danger remove-form">âœ–</button></td>
        </tr>`;
      $('#formset-body').append(newRow);
      $('#id_form-TOTAL_FORMS').val(++formIdx);
      updateTotal();
    });
  });
</script>
</body>
</html>
