<h2>ğŸ“Š Manager Dashboard</h2>

<a href="{% url 'manager_dashboard' %}" class="btn btn-secondary">Return to manager dashboard</a>
<form method="get" style="margin-bottom: 20px;">
  <label for="range">Time Range:</label>
  <select name="range" id="range" onchange="this.form.submit()">
    <option value="day" {% if range_type == "day" %}selected{% endif %}>Today</option>
    <option value="week" {% if range_type == "week" %}selected{% endif %}>This Week</option>
    <option value="month" {% if range_type == "month" %}selected{% endif %}>This Month</option>
  </select>
</form>

<!-- Summary cards -->
<div style="display: flex; flex-wrap: wrap; gap: 1em; margin-bottom: 20px;">
  <div class="card">ğŸ§ª Samples Received: <strong>{{ summary.samples_received }}</strong></div>
  <div class="card">ğŸ” Tests Assigned: <strong>{{ summary.test_assignments }}</strong></div>
  <div class="card">ğŸ‘©â€ğŸ”¬ With Analysts: <strong>{{ summary.assigned_with_analysts }}</strong></div>
  <div class="card">âš™ï¸ Active Equipment: <strong>{{ summary.active_equipment }}</strong></div>
  <div class="card">â° Expired Calibrations: <strong>{{ summary.expired_calibrations }}</strong></div>
</div>

<!-- Top Parameters -->
<h3>ğŸ† Top Parameters by Income</h3>
<table>
  <thead>
    <tr><th>Parameter</th><th>Total Tests</th><th>Total Income (â‚¦)</th></tr>
  </thead>
  <tbody>
    {% for param in top_parameters %}
      <tr>
        <td>{{ param.parameter_name }}</td>
        <td>{{ param.total_tests }}</td>
        <td>â‚¦{{ param.total_income|floatformat:2 }}</td>
      </tr>
    {% empty %}
      <tr><td colspan="3">No data found for this range.</td></tr>
    {% endfor %}
  </tbody>
</table>

<!-- Analyst Breakdown -->
<h3>ğŸ‘©â€ğŸ”¬ Analyst Activity</h3>
<table>
  <thead>
    <tr><th>Analyst</th><th>Total Tests</th><th>Distinct Samples</th></tr>
  </thead>
  <tbody>
    {% for analyst in analyst_workload %}
      <tr>
        <td>{{ analyst.analyst_name }}</td>
        <td>{{ analyst.total_tests }}</td>
        <td>
          {% for s in sample_per_analyst %}
            {% if s.analyst_name == analyst.analyst_name %}
              {{ s.sample_count }}
            {% endif %}
          {% endfor %}
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Parameter Volume -->
<h3>ğŸ“¦ Parameters Conducted</h3>
<table>
  <thead>
    <tr><th>Parameter</th><th>Test Count</th></tr>
  </thead>
  <tbody>
    {% for p in parameter_stats %}
      <tr>
        <td>{{ p.parameter_name }}</td>
        <td>{{ p.test_count }}</td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Analysis Summary -->
<h3>ğŸ§ª Analysis Performed</h3>
<table>
  <thead>
    <tr>
      <th>Date Received</th>
      <th>Client</th>
      <th>Parameter Group</th>
      <th>No. of Samples</th>
      <th>Amount Charged (â‚¦)</th>
    </tr>
  </thead>
  <tbody>
    {% for row in analysis_summary %}
      <tr>
        <td>{{ row.date_received|date:"Y-m-d" }}</td>
        <td>{{ row.client_name }}</td>
        <td>{{ row.parameter_group }}</td>
        <td>{{ row.sample_count }}</td>
        <td>â‚¦{{ row.income|floatformat:2 }}</td>
      </tr>
    {% empty %}
      <tr><td colspan="5">No analysis data found for this range.</td></tr>
    {% endfor %}
  </tbody>
</table>

<h4 style="margin-top: 15px;">ğŸ’µ Total Income ({{ range_type|title }}): <strong>â‚¦{{ total_income|floatformat:2 }}</strong></h4>

<!-- Revenue Summary -->
<h3>ğŸ’° Revenue Summary</h3>
<h4>Today: â‚¦{{ today_total_income|floatformat:2 }} from {{ today_test_count }} tests</h4>

<h4 style="margin-top: 15px;">Trends</h4>
<table>
  <thead><tr><th>Period</th><th>Revenue (â‚¦)</th></tr></thead>
  <tbody>
    {% for r in daily_totals %}
      <tr><td>{{ r.day|date:"Y-m-d" }}</td><td>â‚¦{{ r.income|floatformat:2 }}</td></tr>
    {% endfor %}
    {% for r in weekly_totals %}
      <tr><td>{{ r.week|date:"Y-m-d" }}</td><td>â‚¦{{ r.income|floatformat:2 }}</td></tr>
    {% endfor %}
    {% for r in monthly_totals %}
      <tr><td>{{ r.month|date:"F Y" }}</td><td>â‚¦{{ r.income|floatformat:2 }}</td></tr>
    {% endfor %}
  </tbody>
</table>

<!-- Export Options -->
<div class="export-section" style="margin-top: 40px; padding: 20px; border: 1px solid #ddd; background: #f9f9f9;">
  <h3 class="section-title">
    <i class="fas fa-download"></i>
    Export Reports
  </h3>
  <div class="d-flex gap-3 flex-wrap" style="margin-top: 10px; margin-bottom: 15px;">
    <a href="{% url 'export_report_pdf' %}?range={{ range_type }}" class="export-btn btn-pdf">
      <i class="fas fa-file-pdf"></i>
      Download PDF Report
    </a>
    <a href="{% url 'export_report_excel' %}?range={{ range_type }}" class="export-btn btn-excel">
      <i class="fas fa-file-excel"></i>
      Download Excel Report
    </a>
  </div>
  <div class="compliance-note" style="font-size: 0.9em; color: #555;">
    <i class="fas fa-info-circle me-2"></i>
    <strong>ISO 17025 Compliance:</strong> All reports are generated in accordance with ISO 17025:2017 standards for testing and calibration laboratories.
  </div>
</div>
