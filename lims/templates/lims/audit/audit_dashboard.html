<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Audit Trail Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', sans-serif;
    }
    .card {
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    .badge {
      font-size: 0.75rem;
    }
    .collapse-row {
      background-color: #f1f1f1;
    }
    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      margin-bottom: 0;
    }
  </style>
</head>
<body>
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="fas fa-history"></i> Audit Trail</h3>
    <a href="{% url 'manager_dashboard' %}" class="btn btn-sm btn-primary">Back</a>
  </div>

  <!-- Filter Section -->
  <form method="get" class="row g-2 align-items-center mb-3">
    <div class="col-md-2">
      <select name="action" class="form-select form-select-sm" onchange="this.form.submit()">
        <option value="">All Actions</option>
        <option value="+" {% if request.GET.action == '+' %}selected{% endif %}>Created</option>
        <option value="~" {% if request.GET.action == '~' %}selected{% endif %}>Updated</option>
        <option value="-" {% if request.GET.action == '-' %}selected{% endif %}>Deleted</option>
      </select>
    </div>
    <div class="col-md-2">
      <input name="user" type="text" placeholder="Username" value="{{ request.GET.user }}" class="form-control form-control-sm"/>
    </div>
    <div class="col-md-2">
      <select name="role" class="form-select form-select-sm" onchange="this.form.submit()">
        <option value="">All Roles</option>
        <option value="clerk" {% if request.GET.role == 'clerk' %}selected{% endif %}>Clerk</option>
        <option value="analyst" {% if request.GET.role == 'analyst' %}selected{% endif %}>Analyst</option>
        <option value="manager" {% if request.GET.role == 'manager' %}selected{% endif %}>Manager</option>
      </select>
    </div>
    <div class="col-md-2">
      <button class="btn btn-sm btn-outline-secondary" type="submit">Filter</button>
    </div>
    <div class="col-md-4">
      <input id="searchInput" class="form-control form-control-sm" placeholder="Search table..."/>
    </div>
  </form>

  <!-- Audit Table -->
  <div class="card">
    <div class="card-body p-0">
      <table class="table table-hover table-striped mb-0" id="auditTable">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>User</th>
            <th>Model</th>
            <th>Action</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
          {% regroup logs by display_user as user_groups %}
          {% for group in user_groups %}
            <tr class="table-secondary">
              <td colspan="5"><strong>{{ group.grouper }}</strong></td>
            </tr>
            {% for log in group.list %}
              <tr>
                <td>{{ log.history_date|date:"Y-m-d H:i" }}</td>
                <td>{{ log.display_user }}</td>
                <td>{{ log.history_object }}</td>
                <td>
                  {% if log.history_type == '+' %}
                    <span class="badge bg-success"><i class="fas fa-plus"></i> Created</span>
                  {% elif log.history_type == '~' %}
                    <span class="badge bg-warning text-dark"><i class="fas fa-edit"></i> Updated</span>
                  {% elif log.history_type == '-' %}
                    <span class="badge bg-danger"><i class="fas fa-trash"></i> Deleted</span>
                  {% endif %}
                </td>
                <td>
                  <button class="btn btn-sm btn-outline-primary toggle-details" data-target="details-{{ forloop.counter0 }}">View</button>
                </td>
              </tr>
              <tr id="details-{{ forloop.counter0 }}" class="collapse-row" style="display: none;">
                <td colspan="5">
                  <pre class="bg-light p-2 border rounded">{{ log.diff }}</pre>
                </td>
              </tr>
            {% endfor %}
          {% empty %}
            <tr>
              <td colspan="5" class="text-center py-4 text-muted">
                <i class="fas fa-info-circle"></i> No logs found.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Pagination -->
  {% if page_obj.has_other_pages %}
  <nav class="mt-3">
    <ul class="pagination justify-content-center pagination-sm">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.previous_page_number }}">Previous</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Previous</span></li>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
          <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
          <li class="page-item"><a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ num }}">{{ num }}</a></li>
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.next_page_number }}">Next</a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Next</span></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Toggle detail rows
  document.querySelectorAll('.toggle-details').forEach(btn => {
    btn.addEventListener('click', function () {
      const target = document.getElementById(this.dataset.target);
      const isVisible = target.style.display === 'table-row';
      target.style.display = isVisible ? 'none' : 'table-row';
      this.textContent = isVisible ? 'View' : 'Hide';
    });
  });

  // Search filter
  document.getElementById('searchInput').addEventListener('input', function () {
    const search = this.value.toLowerCase();
    document.querySelectorAll('#auditTable tbody tr').forEach(row => {
      if (!row.classList.contains('collapse-row') && !row.classList.contains('table-secondary')) {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(search) ? '' : 'none';
      }
    });
  });
</script>
</body>
</html>
