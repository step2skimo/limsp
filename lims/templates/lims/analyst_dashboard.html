<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Analyst Dashboard | JGL Labs</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 40px;
      color: #222;
      background: #f8f9fa;
    }
    h2, h3 {
      color: #2c3e50;
    }
    .stats-panel {
      background: #ffffff;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid #2980b9;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }
    .stats-panel ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    .stats-panel li {
      margin-bottom: 6px;
      font-size: 0.95em;
    }
    .progress-container {
      background: #e0e0e0;
      border-radius: 20px;
      overflow: hidden;
      height: 16px;
      margin-bottom: 10px;
    }
    .progress-bar {
      background: #27ae60;
      height: 100%;
      text-align: center;
      color: white;
      font-size: 12px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-bottom: 30px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      font-size: 0.95em;
    }
    th {
      background: #f1f1f1;
    }
    tr:nth-child(even) {
      background-color: #fafafa;
    }
    .status-pill {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.85em;
      color: white;
      display: inline-block;
    }
    .status-pending { background: #e67e22; }
    .status-completed { background: #2ecc71; }
    .status-verified { background: #1abc9c; }
    .deadline-tag {
      background: #c0392b;
      color: white;
      font-size: 0.75em;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 6px;
    }
    .full-entry-link a {
      padding: 6px 12px;
      background: #2d98da;
      color: white;
      text-decoration: none;
      border-radius: 4px;
      font-size: 0.9em;
    }
    .control-label {
      font-size: 0.85em;
      background: #dfe6e9;
      color: #2d3436;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 6px;
    }
  </style>
</head>
<body>
<div style="text-align: right;">
  <a href="{% url 'notifications:list' %}" class="nav-link" style="text-decoration: none; font-weight: bold;">
    ğŸ”” Notifications <span id="notif-badge" class="badge" style="display:none; background:red; color:white; padding:2px 8px; border-radius:12px;">0</span>
  </a>
</div>
 <a href="{% url 'logout' %}" class="nav-link" style="text-decoration: none; font-weight: bold;">
    Logout <span id="notif-badge" class="badge" style="display:none; background:red; color:white; padding:2px 8px; border-radius:12px;">0</span>
  </a>

         {% include "lims/qc/partials/qc_chart.html" %}
</div>
<h2>ğŸ‘‹ Welcome, {{ request.user.first_name }}!</h2>
<p>Today is {{ today|date:"l, F j, Y" }}</p>

<div class="stats-panel">
  <h3>ğŸ“Š My Quality Stats</h3>
  <ul>
    <li><strong>Pending Samples:</strong> {{ stats.samples }}</li>
    <li><strong>Pending Controls:</strong> {{ stats.controls }}</li>
    <li><strong>Overdue Tests:</strong> {{ stats.overdue }}</li>
    <li><strong>Completed (Last 7 Days):</strong> {{ stats.completed_last_7_days }}</li>
  </ul>
  {% if stats.total %}
    <div class="progress-container">
      <div class="progress-bar" style="width: {{ stats.completed_percent }}%;">
        {{ stats.completed_percent }}%
      </div>
    </div>
  {% endif %}
</div>

<div style="background: #e8f5e9; padding: 12px; border-left: 4px solid #27ae60; margin-bottom: 20px;">
  <strong>ğŸ“Œ ISO 17025 Tip:</strong> Always ensure results are submitted within specified turnaround times and controls are validated before reporting.
</div>

{% if nudge_message %}
  <div style="background: #f0f9f9; border-left: 5px solid #2ecc71; padding: 1em; margin-bottom: 1em;">
    <strong>ğŸ’¡ AI Performance Nudge:</strong>
    <p>{{ nudge_message }}</p>
  </div>
{% endif %}

<input type="text" id="test-search" placeholder="ğŸ” Search tests..." style="padding: 8px; width: 100%; margin-bottom: 15px;">

<button onclick="exportTableToExcel('test-table')" style="margin-bottom: 20px;">ğŸ“¥ Export to Excel</button>

{% if grouped_assignments %}
  {% for parameter_name, tests in grouped_assignments.items %}
    <section>
      <h3>ğŸ§ª Parameter: <strong>{{ parameter_name }}</strong></h3>
      <table id="test-table">
        <thead>
          <tr>
            <th>Sample</th>
            <th>Method</th>
            <th>Status</th>
            <th>Full Entry</th>
          </tr>
        </thead>
        <tbody>
          {% for test in tests %}
            <tr>
              <td>
  {{ test.sample.sample_code }}
  {% if test.is_control and test.sample.sample_type == "QC" %}
    <span class="control-label">ğŸ”¬ Control</span>
  {% endif %}

  {% if test.days_since_received is not None %}
    <br><small>{{ test.days_since_received }} day{{ test.days_since_received|pluralize }} ago</small>

    {% if test.days_since_received > 3 %}
      <span class="deadline-tag">âš ï¸ {{ test.days_since_received }} days overdue</span>
    {% endif %}
  {% endif %}
</td>

              <td><small>{{ test.parameter.method }}</small></td>
              <td>
                <span class="status-pill status-{{ test.status }}">
                  {{ test.status|title }}
                </span>
              </td>
              <td class="full-entry-link">
                <a href="{% url 'enter_result' test.id %}">ğŸ“„ Enter Result</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>
  {% endfor %}
{% else %}
  <p>ğŸ‰ All assigned tests have been completed.</p>
{% endif %}

<a href="{% url 'result_history' %}">ğŸ“„ View Submission History</a> |
<a href="{% url 'analyst_qc_dashboard' %}">ğŸ“ˆ My QC Charts</a>



<script>
  // Notification polling
  function pollNotifications() {
    fetch("{% url 'notifications:unread_count' %}")
      .then(res => res.json())
      .then(data => {
        const badge = document.getElementById("notif-badge");
        if (data.unread > 0) {
          badge.textContent = data.unread;
          badge.style.display = "inline-block";
        } else {
          badge.style.display = "none";
        }
      });
  }
  setInterval(pollNotifications, 15000);
  pollNotifications();

  // Live search
  document.getElementById("test-search").addEventListener("input", function () {
    const filter = this.value.toLowerCase();
    document.querySelectorAll("table tbody tr").forEach(row => {
      row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
    });
  });

  // Excel Export
  function exportTableToExcel(tableID, filename = 'test_assignments.xls') {
    const table = document.getElementById(tableID);
    const html = table.outerHTML.replace(/ /g, '%20');
    const link = document.createElement("a");
    link.href = 'data:application/vnd.ms-excel,' + html;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  // AI Toggle
  document.getElementById("ask-lab-ai").onclick = function () {
    const modal = document.getElementById("ai-modal");
    modal.style.display = modal.style.display === "none" ? "block" : "none";
  }

  
</script>
{% include "components/ai_assistant.html" %}
</body>
</html>
