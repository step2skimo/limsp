<!-- AI Assistant Modal -->
<div id="ai-modal" style="
  display: none;
  position: fixed;
  bottom: 80px;
  right: 20px;
  width: 360px;
  max-height: 520px;
  overflow: hidden;
  background: white;
  border: 1px solid #ccc;
  border-radius: 8px;
  box-shadow: 0 5px 10px rgba(0,0,0,0.2);
  z-index: 9999;
  display: flex;
  flex-direction: column;
">
  <!-- Header -->
  <div style="padding: 10px 15px; background: #2c3e50; color: white; font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
    üí° Ask Lab AI
    <button onclick="toggleModalSize()" style="background: none; border: none; color: white; cursor: pointer;">üóï</button>
  </div>

  <!-- Body -->
  <div id="ai-body" style="padding: 10px 15px; overflow-y: auto; flex: 1;">
    <textarea id="ai-input" placeholder="e.g., How to perform fat extraction?" style="width: 100%; height: 60px; resize: vertical;"></textarea>
    <button id="ask-button" onclick="askAI()" style="margin-top: 8px;">Ask</button>

    <div id="ai-response" style="
      margin-top: 12px;
      font-size: 14px;
      max-height: 180px;
      overflow-y: auto;
      border: 1px solid #eee;
      padding: 8px;
      border-radius: 6px;
      background: #f9f9f9;
      white-space: pre-wrap;
    "></div>

    <div id="ai-history" style="
      margin-top: 12px;
      font-size: 13px;
      max-height: 120px;
      overflow-y: auto;
      border-top: 1px solid #ccc;
      padding-top: 8px;
      display: none;
    "></div>
  </div>
</div>

<!-- Floating Button -->
<div id="ask-lab-ai" style="
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #2c3e50;
  color: white;
  padding: 10px 14px;
  border-radius: 8px;
  font-size: 14px;
  cursor: pointer;
">
  üí¨ Ask Lab AI
</div>

<!-- Spinner Style -->
<style>
  .spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #ccc;
    border-top-color: #2c3e50;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    margin-right: 6px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>

<script>
  // Toggle modal visibility
  document.getElementById("ask-lab-ai").onclick = function () {
    const modal = document.getElementById("ai-modal");
    modal.style.display = modal.style.display === "none" ? "flex" : "none";
  };

  // Toggle modal size (minimize/expand)
  function toggleModalSize() {
    const body = document.getElementById("ai-body");
    body.style.display = body.style.display === "none" ? "block" : "none";
  }

  // Ask AI function with spinner and history
  function askAI() {
    const input = document.getElementById("ai-input");
    const question = input.value.trim();
    const responseDiv = document.getElementById("ai-response");
    const historyDiv = document.getElementById("ai-history");

    if (!question) {
      responseDiv.innerText = "‚ö†Ô∏è Please enter a question first.";
      return;
    }

    // Show spinner
    responseDiv.innerHTML = `<div><span class="spinner"></span>Thinking...</div>`;
    input.disabled = true;

    fetch("{% url 'ask_lab_ai' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: "prompt=" + encodeURIComponent(question)
    })
    .then(res => res.json())
    .then(data => {
      responseDiv.innerText = data.reply;

      // Save to history
      const historyItem = document.createElement("div");
      historyItem.innerHTML = `<strong>Q:</strong> ${question}<br><strong>A:</strong> ${data.reply}<hr>`;
      historyDiv.style.display = "block";
      historyDiv.prepend(historyItem);
    })
    .catch(() => {
      responseDiv.innerText = "‚ùå Error getting response. Please try again.";
    })
    .finally(() => {
      input.disabled = false;
      input.value = "";
    });
  }

  // Enter key submits the form
  document.getElementById("ai-input").addEventListener("keydown", function (event) {
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault();
      askAI();
    }
  });
</script>
